{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/saefs/Downloads/vds-hub/vds-hub/public/vds-hub/vds-hub/lib/prisma.ts"],"sourcesContent":["import { PrismaClient } from \"@prisma/client\"\r\n\r\ndeclare global {\r\n  // eslint-disable-next-line no-var\r\n  var prisma: PrismaClient | undefined\r\n}\r\n\r\nexport const prisma: PrismaClient = global.prisma ?? new PrismaClient()\r\n\r\nif (process.env.NODE_ENV !== \"production\") {\r\n  global.prisma = prisma\r\n}\r\n\r\n\r\n"],"names":[],"mappings":";;;;AAAA;;AAOO,MAAM,SAAuB,OAAO,MAAM,IAAI,IAAI,6IAAY;AAErE,wCAA2C;IACzC,OAAO,MAAM,GAAG;AAClB","debugId":null}},
    {"offset": {"line": 66, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/saefs/Downloads/vds-hub/vds-hub/public/vds-hub/vds-hub/app/api/crystalpay/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server'\r\nimport { prisma } from '@/lib/prisma'\r\n\r\nexport async function POST(request: Request) {\r\n  try {\r\n    const body = await request.json()\r\n\r\n\r\n    if (body.id) {\r\n      return handleStatusCheck(body.id)\r\n    }\r\n\r\n\r\n    return handleCreateInvoice(body)\r\n\r\n  } catch (err: any) {\r\n    console.error('üö´ Error:', err)\r\n    return NextResponse.json({\r\n      success: false,\r\n      error: err.message\r\n    }, { status: 500 })\r\n  }\r\n}\r\n\r\n\r\nasync function handleStatusCheck(id: string) {\r\n  const auth_login = process.env.AUTH_LOGIN!\r\n  const auth_secret = process.env.AUTH_SECRET!\r\n\r\n  if (!auth_login || !auth_secret) {\r\n    return NextResponse.json({\r\n      success: false,\r\n      error: '‚ùå Credentials'\r\n    }, { status: 500 })\r\n  }\r\n\r\n  const res = await fetch('https://api.crystalpay.io/v3/invoice/status/', {\r\n    method: 'POST',\r\n    headers: { 'Content-Type': 'application/json' },\r\n    body: JSON.stringify({ auth_login, auth_secret, id }),\r\n  })\r\n\r\n  const data = await res.json()\r\n\r\n  if (!res.ok || data.error) {\r\n    return NextResponse.json({\r\n      success: false,\r\n      error: data.errors?.[0] || data.error || 'API Error'\r\n    }, { status: 400 })\r\n  }\r\n\r\n  // üë§ PARSE userId –∏–∑ extra\r\n  const userIdMatch = data.extra?.match(/userId:([a-zA-Z0-9_-]+)/)\r\n  const userId = userIdMatch?.[1]\r\n\r\n  if (!userId) {\r\n    return NextResponse.json({\r\n      success: false,\r\n      error: '‚ùå userId –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ extra'\r\n    }, { status: 400 })\r\n  }\r\n\r\n  const isPaid = data.state === 'payed'\r\n\r\n\r\n  if (isPaid) {\r\n    await autoCredit(userId, String(id), Number(data.amount), data.currency)\r\n  }\r\n\r\n  // üéâ RESPONSE\r\n  return NextResponse.json({\r\n    success: true,\r\n    paid: isPaid,\r\n    status: data.state,\r\n    amount: data.amount,\r\n    userId,\r\n    message: isPaid ? '‚úÖ –û–ü–õ–ê–ß–ï–ù–û & –ü–û–ü–û–õ–ù–ï–ù–û!' : '‚è≥ –û–∂–∏–¥–∞–µ–º...'\r\n  })\r\n}\r\n\r\n// üî• 2. AUTO-CREDIT (idempotent)\r\nasync function autoCredit(userId: string, externalId: string, amount: number, currency: string) {\r\n  await prisma.$transaction(async (tx: any) => {\r\n    // Transaction exists? Update\r\n    const transaction = await tx.transaction.updateMany({\r\n      where: {\r\n        externalId,\r\n        method: 'crystalpay',\r\n        status: 'pending',\r\n      },\r\n      data: {\r\n        status: 'completed',\r\n        completedAt: new Date(),\r\n      },\r\n    })\r\n\r\n    if (transaction.count === 0) {\r\n      return\r\n    }\r\n\r\n    // üíµ +BALANCE\r\n    await tx.profile.update({\r\n      where: { userId },\r\n      data: { balance: { increment: amount } },\r\n    })\r\n\r\n    // –†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –±–æ–Ω—É—Å (10%)\r\n    const user = await tx.user.findUnique({\r\n      where: { id: userId },\r\n      select: { referredBy: true },\r\n    })\r\n\r\n    if (user?.referredBy) {\r\n      const referralBonus = amount * 0.1\r\n      \r\n      await tx.profile.update({\r\n        where: { userId: user.referredBy },\r\n        data: { balance: { increment: referralBonus } },\r\n      })\r\n\r\n      await tx.referral.updateMany({\r\n        where: {\r\n          referrerId: user.referredBy,\r\n          referredId: userId,\r\n        },\r\n        data: {\r\n          earnings: { increment: referralBonus },\r\n        },\r\n      })\r\n\r\n      await tx.transaction.create({\r\n        data: {\r\n          userId: user.referredBy,\r\n          amount: referralBonus,\r\n          currency: 'USD',\r\n          method: 'referral',\r\n          status: 'completed',\r\n          description: `–†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –±–æ–Ω—É—Å 10% –æ—Ç –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è`,\r\n          type: 'referral',\r\n          completedAt: new Date(),\r\n        },\r\n      })\r\n    }\r\n  })\r\n}\r\n\r\n// üî• 3. CREATE INVOICE (—Ç–≤–æ–π –∫–æ–¥ + lifetime/body)\r\nasync function handleCreateInvoice(body: any) {\r\n  const { amount, description, userId, currency = \"USD\", lifetime = 60 } = body\r\n\r\n  // VALIDATION\r\n  if (!userId || !amount || amount < 10) {\r\n    return NextResponse.json({\r\n      success: false,\r\n      error: '‚ùå userId + ‚â•$10'\r\n    }, { status: 400 })\r\n  }\r\n\r\n  const auth_login = process.env.AUTH_LOGIN!\r\n  const auth_secret = process.env.AUTH_SECRET!\r\n  let redirect_url = process.env.REDIRECT_URL || \"localhost:3000/dashboard/billing\"\r\n\r\n  if (!redirect_url.startsWith(\"http\")) redirect_url = `https://${redirect_url.replace(/^\\/+/, \"\")}`\r\n  // –î–æ–±–∞–≤–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ —Å –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã\r\n  redirect_url += `?tx=${Date.now()}`\r\n\r\n  // –ò—Å–ø–æ–ª—å–∑—É–µ–º JSON —Ñ–æ—Ä–º–∞—Ç –¥–ª—è extra (–±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω—ã–π)\r\n  const payload = {\r\n    auth_login,\r\n    auth_secret,\r\n    amount: Number(amount.toFixed(2)),\r\n    lifetime, // –ò–∑ body!\r\n    type: \"topup\",\r\n    currency: currency,\r\n    description: description || \"–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞\",\r\n    extra: JSON.stringify({ userId }), // JSON —Ñ–æ—Ä–º–∞—Ç –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏\r\n    redirect_url,\r\n  }\r\n\r\n  const res = await fetch(\"https://api.crystalpay.io/v3/invoice/create/\", {\r\n    method: \"POST\",\r\n    headers: { \"Content-Type\": \"application/json\" },\r\n    body: JSON.stringify(payload),\r\n  })\r\n\r\n  const data = await res.json()\r\n\r\n  if (!res.ok || data.error) {\r\n    return NextResponse.json({\r\n      success: false,\r\n      error: data.errors?.join(', ') || data.error || 'API Error'\r\n    }, { status: 400 })\r\n  }\r\n\r\n  // üóÑÔ∏è TRANSACTION\r\n  await prisma.transaction.create({\r\n    data: {\r\n      userId,\r\n      amount: Number(data.amount),\r\n      currency: data.currency ?? \"USD\",\r\n      method: 'crystalpay',\r\n      status: 'pending',\r\n      externalId: String(data.id),\r\n    },\r\n  })\r\n\r\n  return NextResponse.json({\r\n    success: true,\r\n    url: data.url, // –†–µ–¥–∏—Ä–µ–∫—Ç —Å—é–¥–∞!\r\n    id: data.id,\r\n    message: '‚úÖ –ì–æ—Ç–æ–≤–æ! –ü–µ—Ä–µ—Ö–æ–¥–∏–º...'\r\n  })\r\n}"],"names":[],"mappings":"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","debugId":null}}]
}