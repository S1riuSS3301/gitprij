{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/saefs/Downloads/vds-hub/vds-hub/lib/prisma.ts"],"sourcesContent":["import { PrismaClient } from \"@prisma/client\"\r\n\r\ndeclare global {\r\n  // eslint-disable-next-line no-var\r\n  var prisma: PrismaClient | undefined\r\n}\r\n\r\nexport const prisma: PrismaClient = global.prisma ?? new PrismaClient()\r\n\r\nif (process.env.NODE_ENV !== \"production\") {\r\n  global.prisma = prisma\r\n}\r\n\r\n\r\n"],"names":[],"mappings":";;;;AAAA;;AAOO,MAAM,SAAuB,OAAO,MAAM,IAAI,IAAI,6IAAY;AAErE,wCAA2C;IACzC,OAAO,MAAM,GAAG;AAClB","debugId":null}},
    {"offset": {"line": 66, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/saefs/Downloads/vds-hub/vds-hub/app/api/crystalpay/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server'\r\nimport { prisma } from '@/lib/prisma'\r\n\r\nexport async function POST(request: Request) {\r\n  try {\r\n    const body = await request.json()\r\n\r\n    // üî• –î–í–û–ô–ù–ê–Ø –õ–û–ì–ò–ö–ê: CHECK or CREATE\r\n    if (body.id) {\r\n      return handleStatusCheck(body.id)\r\n    }\r\n\r\n    // CREATE (—Å—Ç–∞—Ä—ã–π –∫–æ–¥ + —É–ª—É—á—à–µ–Ω–∏—è)\r\n    return handleCreateInvoice(body)\r\n\r\n  } catch (err: any) {\r\n    console.error('üö´ Error:', err)\r\n    return NextResponse.json({\r\n      success: false,\r\n      error: err.message\r\n    }, { status: 500 })\r\n  }\r\n}\r\n\r\n// üî• 1. CHECK STATUS (–ø–æ—Å–ª–µ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞ ?tx=1)\r\nasync function handleStatusCheck(id: string) {\r\n  const auth_login = process.env.AUTH_LOGIN!\r\n  const auth_secret = process.env.AUTH_SECRET!\r\n\r\n  if (!auth_login || !auth_secret) {\r\n    return NextResponse.json({\r\n      success: false,\r\n      error: '‚ùå Credentials'\r\n    }, { status: 500 })\r\n  }\r\n\r\n  // üì° API STATUS\r\n  const res = await fetch('https://api.crystalpay.io/v3/invoice/status/', {\r\n    method: 'POST',\r\n    headers: { 'Content-Type': 'application/json' },\r\n    body: JSON.stringify({ auth_login, auth_secret, id }),\r\n  })\r\n\r\n  const data = await res.json()\r\n  console.log('üìä Status:', data)\r\n\r\n  if (!res.ok || data.error) {\r\n    return NextResponse.json({\r\n      success: false,\r\n      error: data.errors?.[0] || data.error || 'API Error'\r\n    }, { status: 400 })\r\n  }\r\n\r\n  // üë§ PARSE userId –∏–∑ extra\r\n  const userIdMatch = data.extra?.match(/userId:([a-zA-Z0-9_-]+)/)\r\n  const userId = userIdMatch?.[1]\r\n\r\n  if (!userId) {\r\n    return NextResponse.json({\r\n      success: false,\r\n      error: '‚ùå userId –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ extra'\r\n    }, { status: 400 })\r\n  }\r\n\r\n  const isPaid = data.state === 'payed'\r\n\r\n  // üí∞ AUTO-CREDIT –µ—Å–ª–∏ paid + pending\r\n  if (isPaid) {\r\n    await autoCredit(userId, String(id), Number(data.amount), data.currency)\r\n  }\r\n\r\n  // üéâ RESPONSE\r\n  return NextResponse.json({\r\n    success: true,\r\n    paid: isPaid,\r\n    status: data.state,\r\n    amount: data.amount,\r\n    userId,\r\n    message: isPaid ? '‚úÖ –û–ü–õ–ê–ß–ï–ù–û & –ü–û–ü–û–õ–ù–ï–ù–û!' : '‚è≥ –û–∂–∏–¥–∞–µ–º...'\r\n  })\r\n}\r\n\r\n// üî• 2. AUTO-CREDIT (idempotent)\r\nasync function autoCredit(userId: string, externalId: string, amount: number, currency: string) {\r\n  await prisma.$transaction(async (tx) => {\r\n    // Transaction exists? Update\r\n    const transaction = await tx.transaction.updateMany({\r\n      where: {\r\n        externalId,\r\n        method: 'crystalpay',\r\n        status: 'pending',\r\n      },\r\n      data: {\r\n        status: 'completed',\r\n        completedAt: new Date(),\r\n      },\r\n    })\r\n\r\n    if (transaction.count === 0) {\r\n      console.warn('‚ö†Ô∏è –ù–µ—Ç pending tx')\r\n      return\r\n    }\r\n\r\n    // üíµ +BALANCE\r\n    await tx.profile.update({\r\n      where: { userId },\r\n      data: { balance: { increment: amount } },\r\n    })\r\n\r\n    console.log(`üí∞ +$${amount} ‚Üí ${userId} ‚úÖ`)\r\n  })\r\n}\r\n\r\n// üî• 3. CREATE INVOICE (—Ç–≤–æ–π –∫–æ–¥ + lifetime/body)\r\nasync function handleCreateInvoice(body: any) {\r\n  const { amount, description, userId, currency = \"USD\", lifetime = 60 } = body\r\n\r\n  // VALIDATION\r\n  if (!userId || !amount || amount < 10) {\r\n    return NextResponse.json({\r\n      success: false,\r\n      error: '‚ùå userId + ‚â•$10'\r\n    }, { status: 400 })\r\n  }\r\n\r\n  const auth_login = process.env.AUTH_LOGIN!\r\n  const auth_secret = process.env.AUTH_SECRET!\r\n  let redirect_url = process.env.REDIRECT_URL || \"localhost:3000/dashboard/billing\"\r\n\r\n  if (!redirect_url.startsWith(\"http\")) redirect_url = `https://${redirect_url.replace(/^\\/+/, \"\")}`\r\n  redirect_url += `?tx=${Date.now()}`  // Unique tx ID!\r\n\r\n  const payload = {\r\n    auth_login,\r\n    auth_secret,\r\n    amount: Number(amount.toFixed(2)),\r\n    lifetime, // –ò–∑ body!\r\n    type: \"topup\",\r\n    currency: currency,\r\n    description: description || \"–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞\",\r\n    extra: `userId:${userId}`,\r\n    redirect_url,\r\n  }\r\n\r\n  console.log('üöÄ CREATE:', payload)\r\n\r\n  const res = await fetch(\"https://api.crystalpay.io/v3/invoice/create/\", {\r\n    method: \"POST\",\r\n    headers: { \"Content-Type\": \"application/json\" },\r\n    body: JSON.stringify(payload),\r\n  })\r\n\r\n  const data = await res.json()\r\n  console.log('üì• CREATE:', data)\r\n\r\n  if (!res.ok || data.error) {\r\n    return NextResponse.json({\r\n      success: false,\r\n      error: data.errors?.join(', ') || data.error || 'API Error'\r\n    }, { status: 400 })\r\n  }\r\n\r\n  // üóÑÔ∏è TRANSACTION\r\n  await prisma.transaction.create({\r\n    data: {\r\n      userId,\r\n      amount: Number(data.amount),\r\n      currency: data.currency ?? \"USD\",\r\n      method: 'crystalpay',\r\n      status: 'pending',\r\n      externalId: String(data.id),\r\n    },\r\n  })\r\n\r\n  return NextResponse.json({\r\n    success: true,\r\n    url: data.url, // –†–µ–¥–∏—Ä–µ–∫—Ç —Å—é–¥–∞!\r\n    id: data.id,\r\n    message: '‚úÖ –ì–æ—Ç–æ–≤–æ! –ü–µ—Ä–µ—Ö–æ–¥–∏–º...'\r\n  })\r\n}"],"names":[],"mappings":";;;;AAAA;AACA;;;AAEO,eAAe,KAAK,OAAgB;IACzC,IAAI;QACF,MAAM,OAAO,MAAM,QAAQ,IAAI;QAE/B,qCAAqC;QACrC,IAAI,KAAK,EAAE,EAAE;YACX,OAAO,kBAAkB,KAAK,EAAE;QAClC;QAEA,kCAAkC;QAClC,OAAO,oBAAoB;IAE7B,EAAE,OAAO,KAAU;QACjB,QAAQ,KAAK,CAAC,aAAa;QAC3B,OAAO,yLAAY,CAAC,IAAI,CAAC;YACvB,SAAS;YACT,OAAO,IAAI,OAAO;QACpB,GAAG;YAAE,QAAQ;QAAI;IACnB;AACF;AAEA,6CAA6C;AAC7C,eAAe,kBAAkB,EAAU;IACzC,MAAM,aAAa,QAAQ,GAAG,CAAC,UAAU;IACzC,MAAM,cAAc,QAAQ,GAAG,CAAC,WAAW;IAE3C,IAAI,CAAC,cAAc,CAAC,aAAa;QAC/B,OAAO,yLAAY,CAAC,IAAI,CAAC;YACvB,SAAS;YACT,OAAO;QACT,GAAG;YAAE,QAAQ;QAAI;IACnB;IAEA,gBAAgB;IAChB,MAAM,MAAM,MAAM,MAAM,gDAAgD;QACtE,QAAQ;QACR,SAAS;YAAE,gBAAgB;QAAmB;QAC9C,MAAM,KAAK,SAAS,CAAC;YAAE;YAAY;YAAa;QAAG;IACrD;IAEA,MAAM,OAAO,MAAM,IAAI,IAAI;IAC3B,QAAQ,GAAG,CAAC,cAAc;IAE1B,IAAI,CAAC,IAAI,EAAE,IAAI,KAAK,KAAK,EAAE;QACzB,OAAO,yLAAY,CAAC,IAAI,CAAC;YACvB,SAAS;YACT,OAAO,KAAK,MAAM,EAAE,CAAC,EAAE,IAAI,KAAK,KAAK,IAAI;QAC3C,GAAG;YAAE,QAAQ;QAAI;IACnB;IAEA,2BAA2B;IAC3B,MAAM,cAAc,KAAK,KAAK,EAAE,MAAM;IACtC,MAAM,SAAS,aAAa,CAAC,EAAE;IAE/B,IAAI,CAAC,QAAQ;QACX,OAAO,yLAAY,CAAC,IAAI,CAAC;YACvB,SAAS;YACT,OAAO;QACT,GAAG;YAAE,QAAQ;QAAI;IACnB;IAEA,MAAM,SAAS,KAAK,KAAK,KAAK;IAE9B,qCAAqC;IACrC,IAAI,QAAQ;QACV,MAAM,WAAW,QAAQ,OAAO,KAAK,OAAO,KAAK,MAAM,GAAG,KAAK,QAAQ;IACzE;IAEA,cAAc;IACd,OAAO,yLAAY,CAAC,IAAI,CAAC;QACvB,SAAS;QACT,MAAM;QACN,QAAQ,KAAK,KAAK;QAClB,QAAQ,KAAK,MAAM;QACnB;QACA,SAAS,SAAS,4BAA4B;IAChD;AACF;AAEA,iCAAiC;AACjC,eAAe,WAAW,MAAc,EAAE,UAAkB,EAAE,MAAc,EAAE,QAAgB;IAC5F,MAAM,kKAAM,CAAC,YAAY,CAAC,OAAO;QAC/B,6BAA6B;QAC7B,MAAM,cAAc,MAAM,GAAG,WAAW,CAAC,UAAU,CAAC;YAClD,OAAO;gBACL;gBACA,QAAQ;gBACR,QAAQ;YACV;YACA,MAAM;gBACJ,QAAQ;gBACR,aAAa,IAAI;YACnB;QACF;QAEA,IAAI,YAAY,KAAK,KAAK,GAAG;YAC3B,QAAQ,IAAI,CAAC;YACb;QACF;QAEA,cAAc;QACd,MAAM,GAAG,OAAO,CAAC,MAAM,CAAC;YACtB,OAAO;gBAAE;YAAO;YAChB,MAAM;gBAAE,SAAS;oBAAE,WAAW;gBAAO;YAAE;QACzC;QAEA,QAAQ,GAAG,CAAC,CAAC,KAAK,EAAE,OAAO,GAAG,EAAE,OAAO,EAAE,CAAC;IAC5C;AACF;AAEA,kDAAkD;AAClD,eAAe,oBAAoB,IAAS;IAC1C,MAAM,EAAE,MAAM,EAAE,WAAW,EAAE,MAAM,EAAE,WAAW,KAAK,EAAE,WAAW,EAAE,EAAE,GAAG;IAEzE,aAAa;IACb,IAAI,CAAC,UAAU,CAAC,UAAU,SAAS,IAAI;QACrC,OAAO,yLAAY,CAAC,IAAI,CAAC;YACvB,SAAS;YACT,OAAO;QACT,GAAG;YAAE,QAAQ;QAAI;IACnB;IAEA,MAAM,aAAa,QAAQ,GAAG,CAAC,UAAU;IACzC,MAAM,cAAc,QAAQ,GAAG,CAAC,WAAW;IAC3C,IAAI,eAAe,QAAQ,GAAG,CAAC,YAAY,IAAI;IAE/C,IAAI,CAAC,aAAa,UAAU,CAAC,SAAS,eAAe,CAAC,QAAQ,EAAE,aAAa,OAAO,CAAC,QAAQ,KAAK;IAClG,gBAAgB,CAAC,IAAI,EAAE,KAAK,GAAG,IAAI,EAAE,gBAAgB;IAErD,MAAM,UAAU;QACd;QACA;QACA,QAAQ,OAAO,OAAO,OAAO,CAAC;QAC9B;QACA,MAAM;QACN,UAAU;QACV,aAAa,eAAe;QAC5B,OAAO,CAAC,OAAO,EAAE,QAAQ;QACzB;IACF;IAEA,QAAQ,GAAG,CAAC,cAAc;IAE1B,MAAM,MAAM,MAAM,MAAM,gDAAgD;QACtE,QAAQ;QACR,SAAS;YAAE,gBAAgB;QAAmB;QAC9C,MAAM,KAAK,SAAS,CAAC;IACvB;IAEA,MAAM,OAAO,MAAM,IAAI,IAAI;IAC3B,QAAQ,GAAG,CAAC,cAAc;IAE1B,IAAI,CAAC,IAAI,EAAE,IAAI,KAAK,KAAK,EAAE;QACzB,OAAO,yLAAY,CAAC,IAAI,CAAC;YACvB,SAAS;YACT,OAAO,KAAK,MAAM,EAAE,KAAK,SAAS,KAAK,KAAK,IAAI;QAClD,GAAG;YAAE,QAAQ;QAAI;IACnB;IAEA,kBAAkB;IAClB,MAAM,kKAAM,CAAC,WAAW,CAAC,MAAM,CAAC;QAC9B,MAAM;YACJ;YACA,QAAQ,OAAO,KAAK,MAAM;YAC1B,UAAU,KAAK,QAAQ,IAAI;YAC3B,QAAQ;YACR,QAAQ;YACR,YAAY,OAAO,KAAK,EAAE;QAC5B;IACF;IAEA,OAAO,yLAAY,CAAC,IAAI,CAAC;QACvB,SAAS;QACT,KAAK,KAAK,GAAG;QACb,IAAI,KAAK,EAAE;QACX,SAAS;IACX;AACF","debugId":null}}]
}