{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/saefs/Downloads/vds-hub/vds-hub/app/api/crystalpay/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server'\r\nimport { env } from '@/env'\r\n\r\nexport async function POST(request: Request) {\r\n  try {\r\n    const bodyJson = await request.json();\r\n    let { amount, description, userId, currency = \"USD\" } = bodyJson;\r\n\r\n    // Импорт из env вместо process.env\r\n    const auth_login = env.authLogin;\r\n    const auth_secret = env.authSecret;\r\n    let redirect_url = env.REDIRECT_URL || \"localhost:3000/dashboard\";\r\n\r\n    if (!auth_login || !auth_secret) {\r\n      console.error('Credentials missing');\r\n      return NextResponse.json({ error: 'Отсутствуют credentials CrystalPay' }, { status: 500 });\r\n    }\r\n\r\n    if (!redirect_url.startsWith(\"http\")) {\r\n      redirect_url = `https://${redirect_url.replace(/^\\/+/, \"\")}`;\r\n    }\r\n\r\n    amount = Number.parseFloat(amount);\r\n    if (isNaN(amount) || amount < 10) {\r\n      return NextResponse.json({ error: 'Минимальная сумма пополнения: $10.00 USD' }, { status: 400 });\r\n    }\r\n    amount = Number(amount.toFixed(2));\r\n\r\n    if (!userId || typeof userId !== \"string\") {\r\n      return NextResponse.json({ error: 'Отсутствует userId, попробуйте обновить страницу' }, { status: 400 });\r\n    }\r\n\r\n    const payload = {\r\n      auth_login,\r\n      auth_secret,\r\n      amount,\r\n      lifetime: 60,\r\n      currency,\r\n      type: \"purchase\",  // Добавлено для фикса ошибки \"Type field is required\" (альтернатива: \"topup\")\r\n      description: description || \"Пополнение баланса через CrystalPay\",\r\n      extra: `userId:${userId}`,\r\n      redirect_url,\r\n    };\r\n\r\n    console.log('Payload to CrystalPay:', payload); // Лог для отладки\r\n\r\n    const crystalpayRes = await fetch(\"https://api.crystalpay.io/v3/invoice/create/\", {\r\n      method: \"POST\",\r\n      headers: {\r\n        \"Content-Type\": \"application/json\",\r\n      },\r\n      body: JSON.stringify(payload),\r\n    });\r\n\r\n    const cpBody = await crystalpayRes.json();\r\n    console.log('CrystalPay response:', cpBody); // Лог ответа (проверьте терминал на ошибки API)\r\n\r\n    if (!crystalpayRes.ok || cpBody.error) {\r\n      const message = cpBody.errors ? cpBody.errors.join(\", \") : (cpBody.error || \"Ошибка CrystalPay, попробуйте позже.\");\r\n      console.error('CrystalPay error:', message);\r\n      return NextResponse.json({ error: message }, { status: 400 });\r\n    }\r\n\r\n    return NextResponse.json({\r\n      url: cpBody.url,\r\n      id: cpBody.id,\r\n      amount: cpBody.amount,\r\n      currency: cpBody.currency,\r\n      description: cpBody.description,\r\n    });\r\n  } catch (err: any) {\r\n    console.error('Server error:', err.message);\r\n    return NextResponse.json({ error: err.message || \"Internal server error\" }, { status: 500 });\r\n  }\r\n}"],"names":[],"mappings":";;;;AAAA;;;;;;;;AAGO,eAAe,KAAK,OAAgB;IACzC,IAAI;QACF,MAAM,WAAW,MAAM,QAAQ,IAAI;QACnC,IAAI,EAAE,MAAM,EAAE,WAAW,EAAE,MAAM,EAAE,WAAW,KAAK,EAAE,GAAG;QAExD,mCAAmC;QACnC,MAAM,aAAa,IAAI,SAAS;QAChC,MAAM,cAAc,IAAI,UAAU;QAClC,IAAI,eAAe,IAAI,YAAY,IAAI;QAEvC,IAAI,CAAC,cAAc,CAAC,aAAa;YAC/B,QAAQ,KAAK,CAAC;YACd,OAAO,yLAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAqC,GAAG;gBAAE,QAAQ;YAAI;QAC1F;QAEA,IAAI,CAAC,aAAa,UAAU,CAAC,SAAS;YACpC,eAAe,CAAC,QAAQ,EAAE,aAAa,OAAO,CAAC,QAAQ,KAAK;QAC9D;QAEA,SAAS,OAAO,UAAU,CAAC;QAC3B,IAAI,MAAM,WAAW,SAAS,IAAI;YAChC,OAAO,yLAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAA2C,GAAG;gBAAE,QAAQ;YAAI;QAChG;QACA,SAAS,OAAO,OAAO,OAAO,CAAC;QAE/B,IAAI,CAAC,UAAU,OAAO,WAAW,UAAU;YACzC,OAAO,yLAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAmD,GAAG;gBAAE,QAAQ;YAAI;QACxG;QAEA,MAAM,UAAU;YACd;YACA;YACA;YACA,UAAU;YACV;YACA,MAAM;YACN,aAAa,eAAe;YAC5B,OAAO,CAAC,OAAO,EAAE,QAAQ;YACzB;QACF;QAEA,QAAQ,GAAG,CAAC,0BAA0B,UAAU,kBAAkB;QAElE,MAAM,gBAAgB,MAAM,MAAM,gDAAgD;YAChF,QAAQ;YACR,SAAS;gBACP,gBAAgB;YAClB;YACA,MAAM,KAAK,SAAS,CAAC;QACvB;QAEA,MAAM,SAAS,MAAM,cAAc,IAAI;QACvC,QAAQ,GAAG,CAAC,wBAAwB,SAAS,gDAAgD;QAE7F,IAAI,CAAC,cAAc,EAAE,IAAI,OAAO,KAAK,EAAE;YACrC,MAAM,UAAU,OAAO,MAAM,GAAG,OAAO,MAAM,CAAC,IAAI,CAAC,QAAS,OAAO,KAAK,IAAI;YAC5E,QAAQ,KAAK,CAAC,qBAAqB;YACnC,OAAO,yLAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAQ,GAAG;gBAAE,QAAQ;YAAI;QAC7D;QAEA,OAAO,yLAAY,CAAC,IAAI,CAAC;YACvB,KAAK,OAAO,GAAG;YACf,IAAI,OAAO,EAAE;YACb,QAAQ,OAAO,MAAM;YACrB,UAAU,OAAO,QAAQ;YACzB,aAAa,OAAO,WAAW;QACjC;IACF,EAAE,OAAO,KAAU;QACjB,QAAQ,KAAK,CAAC,iBAAiB,IAAI,OAAO;QAC1C,OAAO,yLAAY,CAAC,IAAI,CAAC;YAAE,OAAO,IAAI,OAAO,IAAI;QAAwB,GAAG;YAAE,QAAQ;QAAI;IAC5F;AACF","debugId":null}}]
}